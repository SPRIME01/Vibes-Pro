# Logfire Observability Blueprint

> Traceability: DEV-PRD-018 · DEV-SDS-018 · DEV-PRD-021

This guide captures the Logfire defaults shipped with the VibesPro template.
Cycle 2A will extend these notes with full instrumentation walkthroughs once
`bootstrap_logfire` evolves beyond the stub phased in during Cycle 1.

## Environment Variables

| Variable | Default | Purpose |
| --- | --- | --- |
| `LOGFIRE_TOKEN` | _unset_ | API token for Logfire ingestion (store in secrets for non-local environments). |
| `LOGFIRE_ENVIRONMENT` | `development` | Controls Logfire environment tagging to align with deployment stage. |
| `LOGFIRE_SERVICE_NAME` | `{{ project_slug }}-api` | Service identifier surfaced in Logfire dashboards and OTEL spans. |
| `LOGFIRE_SERVICE_VERSION` | Derived from `APP_VERSION` | Version metadata for trace correlation (optional override). |
| `LOGFIRE_SEND_TO_LOGFIRE` | `if-token-present` | Enables remote export when a token is present; keeps local runs offline by default. |
| `OTEL_EXPORTER_OTLP_ENDPOINT` | `http://localhost:4318` | OTLP HTTP endpoint for spans/logs (Vector locally, OpenObserve remotely). |
| `OTEL_EXPORTER_OTLP_PROTOCOL` | `http/protobuf` | Transport protocol expected by Logfire’s OTLP exporter. |
| `OTEL_SERVICE_NAME` | `{{ project_slug }}-api` | Mirrors Logfire service naming for downstream OTEL tooling. |

## Local Usage

- Keep `LOGFIRE_TOKEN` empty while developing locally. Set
  `LOGFIRE_SEND_TO_LOGFIRE=if-token-present` to control remote export when you add a token.
- Override `LOGFIRE_ENVIRONMENT` per environment (`development`, `staging`,
  `production`) to keep dashboards segmented.
- Point `OTEL_EXPORTER_OTLP_ENDPOINT` at your observability pipeline. The
  defaults target Vector’s local OTLP listener (`http://localhost:4318`).

## Deployment Checklist

1. Store `LOGFIRE_TOKEN` in your secrets manager (SOPS, GitHub Actions, etc.).
2. Promote `LOGFIRE_SEND_TO_LOGFIRE` to `true` (or leave
   `if-token-present` to gate on token availability).
3. Update `LOGFIRE_SERVICE_NAME` if the deployment uses multiple FastAPI apps;
   keep the value aligned with `OTEL_SERVICE_NAME` to preserve dashboards.
4. Add release automation that sets `LOGFIRE_SERVICE_VERSION` to your semantic
   version so traces line up with shipped artifacts.

## Logfire Validation

- `bash tests/ops/test_vector_logfire.sh` — ensures Vector wiring captures Logfire metadata.
- `just test-logs` — runs the log pipeline suite (redaction, correlation, Logfire smoke test).
- `just docs-lint` — verifies docs and templates document the required sections.

Vector relies on the shared VRL program at `tools/vector/macros.vrl` plus the
`transforms.logs_logfire_normalize` block. When you extend Logfire attributes, update the macros,
normalize transform, and rerun the commands above.
